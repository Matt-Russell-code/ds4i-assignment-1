---
title: "DS4I - Project Writeup"
format: html
execute:
  echo: false
  warning: false
  message: false
  results: hide
editor: visual
---

```{r setup}


#libraries 

library(kableExtra)
library(tidyverse)
library(ggplot2)
library(ggpubr)

#theme for ggplot2, let me know if you do not like this theme and we can change it :)

#Theme for ggplot2 
theme_set(
  theme_bw(base_size = 9) +
    theme(
      plot.title   = element_text(hjust = 0.5, size = 9),
      panel.border = element_rect(colour = "black", fill = NA, linewidth = 0.5),
      # keep grids but make them subtle
      panel.grid.major = element_line(colour = "grey85", linewidth = 0.3),
      panel.grid.minor = element_line(colour = "grey92", linewidth = 0.2),
      # base-R style text/ticks
      axis.text  = element_text(colour = "black"),
      axis.title = element_text(colour = "black"),
      axis.ticks = element_line(colour = "black", linewidth = 0.3)
    )
)



#making geompoint have hollow circles
update_geom_defaults(
  "point",
  list(size = 1, alpha = 0.9, shape = 21, colour = "black")
)


```

```{r}
#| echo: false
knitr::include_graphics("av.jpg")

```

[Photo by Nicolas Cool on Unsplash]{style="font-size:12px"}

## Introduction

## Literature Review

## Exploratory Data Analysis

```{r}



```

## Feature Engineering

```{r read_data}

library(lubridate)
data = read.csv("scotland_avalanche_forecasts_2009_2025.csv")


data <- data %>% 
  mutate(across(where(is.character), as.factor))

```

```{r missing_val}

#Getting table of missing values


col.n <- colnames(data)
n <- nrow(data)

missing_df <- data.frame(Variable = character(),
                         "Missing (%)" = numeric(),
                         check.names = F)


for (i in col.n){
  
  x <- sum(is.na(data[,i]))
  
  perc <- (x/n) * 100
  
  missing_df <- rbind(missing_df,
                      data.frame(
                        Variable = i,
                        `Missing (%)` = perc
                      , check.names = F)
                      )
  
}
 
missing_df <- missing_df %>% 
  filter(`Missing (%)` > 0) %>% 
  arrange(desc(`Missing (%)`),)


```

```{r tablex}



kable(missing_df, 
      format = "html",
      digits = 2,
      caption = "Missing Values") %>%
  kable_styling(
    bootstrap_options = c("hover"),
    full_width = FALSE
  ) %>%
  footnote(general = "")


```

```{r check_missing_fnx}

# a few functions to help me evaluate the extent of missing values

#Find percentage of missing values per Column
find_missing <- function(a){
  
  
col.n <- colnames(a)
n <- nrow(a)
missing_df <- data.frame(Variable = character(),
                         "Missing (%)" = numeric(),
                         check.names = F)


for (i in col.n){
  
  x <- sum(is.na(a[,i]))
  
  perc <- (x/n) * 100
  
  missing_df <- rbind(missing_df,
                      data.frame(
                        Variable = i,
                        `Missing (%)` = perc
                      , check.names = F)
                      )
  
}
 
missing_df <- missing_df %>% 
  filter(`Missing (%)` > 0) %>% 
  arrange(desc(`Missing (%)`),)

return(missing_df)

}

#Find total % missing values
find_total_missing <- function(b){
  
  
  count_na <- 0
for (i in 1:nrow(b)){
  if (any(is.na(data[i, ]))){count_na <- count_na +1}
}


count_na/nrow(b)
  
  return(count_na*100/nrow(b) )
}

```

```{r imputation}
#Come back to this later

# 
# #I am not grouping by Date, OsGrid, Obs or OAH (As thats our target variable)
# groupings <- groupings[-c(1, 3, 5, 7)]
# 
# #Cell mean imputation
# 
# #Imputing Training data first
# train.imp <- train %>%
#   group_by(Area, FAH) %>% #cant group by precip code, or location, too many missing
#   mutate(
#     across(where(is.integer),
#            ~ replace_na(., as.integer(round(mean(., na.rm = TRUE))))),
#     across(where(is.double),
#            ~ replace_na(., mean(., na.rm = TRUE)))
#   ) %>% #after this, some variables 
#   ungroup() %>% 
#   mutate(Aspect = round(mean(Aspect, na.rm = T),), #remaining, just taking the mean
#          Max.Temp.Grad = round(mean(Max.Temp.Grad, na.rm = T)),
#          Max.Hardness.Grad = round(mean(Max.Hardness.Grad, na.rm  = T))) 
# 
# train.imp <- train.imp[-which(is.na(train.imp$OAH)),] #removing remaining missing
#   
# 
# #Imputing Test data in the same manner
# test.imp <- test %>%
#   group_by(Area, FAH) %>% #cant group by precip code, or location, too many missing
#   mutate(
#     across(where(is.integer),
#            ~ replace_na(., as.integer(round(mean(., na.rm = TRUE))))),
#     across(where(is.double),
#            ~ replace_na(., mean(., na.rm = TRUE)))
#   ) %>% #after this, some variables 
#   ungroup() %>% 
#   mutate(Aspect = round(mean(Aspect, na.rm = T),), #remaining, just taking the mean
#          Max.Temp.Grad = round(mean(Max.Temp.Grad, na.rm = T)),
#          Max.Hardness.Grad = round(mean(Max.Hardness.Grad, na.rm  = T))) 
# 
# test.imp <- train.imp[-which(is.na(test.imp$OAH)),] #removing remaining missing


```

```{r date_time}

#adding date variable
data$Date <- as.POSIXct(data$Date, format="%Y-%m-%d %H:%M:%S", tz="UTC")


data$month     <- lubridate::month(data$Date)
data$hour      <- lubridate::hour(data$Date)
data$year      <- lubridate::year(data$Date)

#make a day of the season variable

#season begins from December to april



data <- data %>% 
  mutate(season_year = if_else(month >= 12, year, year -1),
         season_id = dense_rank(season_year),
         season = paste0("season", season_id),
         season = as.factor(season)) %>% 
  group_by(season, Area) %>% 
  mutate(dayofseason = row_number()) %>% 
  arrange(Date, Area)



```

```{r drop variables}

#Drop the top 3 variables wtih the most missing values
data <- data %>% 
  select(- c(AV.Cat, Ski.Pen, Summit.Wind.Dir, Obs, Location))

data <- na.omit(data) #remove remaining missing

#data <- data[,!(names(data)) == "Obs"]



```

```{r split_data}

set.seed(1)
train.idx <- sample(1:nrow(data), 
                    round(nrow(data)*0.8))

train <- data[train.idx,] #Training data
test <- data[-train.idx,] #Testing Data


```

## Modelling

## Discussion
