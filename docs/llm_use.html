<!DOCTYPE html>
<html xmlns="http://www.w3.org/1999/xhtml" lang="en" xml:lang="en"><head>

<meta charset="utf-8">
<meta name="generator" content="quarto-1.6.42">

<meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=yes">


<title>LLM use – DS4i Writeup</title>
<style>
code{white-space: pre-wrap;}
span.smallcaps{font-variant: small-caps;}
div.columns{display: flex; gap: min(4vw, 1.5em);}
div.column{flex: auto; overflow-x: auto;}
div.hanging-indent{margin-left: 1.5em; text-indent: -1.5em;}
ul.task-list{list-style: none;}
ul.task-list li input[type="checkbox"] {
  width: 0.8em;
  margin: 0 0.8em 0.2em -1em; /* quarto-specific, see https://github.com/quarto-dev/quarto-cli/issues/4556 */ 
  vertical-align: middle;
}
</style>


<script src="site_libs/quarto-nav/quarto-nav.js"></script>
<script src="site_libs/quarto-nav/headroom.min.js"></script>
<script src="site_libs/clipboard/clipboard.min.js"></script>
<script src="site_libs/quarto-search/autocomplete.umd.js"></script>
<script src="site_libs/quarto-search/fuse.min.js"></script>
<script src="site_libs/quarto-search/quarto-search.js"></script>
<meta name="quarto:offset" content="./">
<script src="site_libs/quarto-html/quarto.js"></script>
<script src="site_libs/quarto-html/popper.min.js"></script>
<script src="site_libs/quarto-html/tippy.umd.min.js"></script>
<script src="site_libs/quarto-html/anchor.min.js"></script>
<link href="site_libs/quarto-html/tippy.css" rel="stylesheet">
<link href="site_libs/quarto-html/quarto-syntax-highlighting-2f5df379a58b258e96c21c0638c20c03.css" rel="stylesheet" id="quarto-text-highlighting-styles">
<script src="site_libs/bootstrap/bootstrap.min.js"></script>
<link href="site_libs/bootstrap/bootstrap-icons.css" rel="stylesheet">
<link href="site_libs/bootstrap/bootstrap-79108a0fc1995748cbd19a5b0e3e3e7c.min.css" rel="stylesheet" append-hash="true" id="quarto-bootstrap" data-mode="light">
<script id="quarto-search-options" type="application/json">{
  "location": "navbar",
  "copy-button": false,
  "collapse-after": 3,
  "panel-placement": "end",
  "type": "overlay",
  "limit": 50,
  "keyboard-shortcut": [
    "f",
    "/",
    "s"
  ],
  "show-item-context": false,
  "language": {
    "search-no-results-text": "No results",
    "search-matching-documents-text": "matching documents",
    "search-copy-link-title": "Copy link to search",
    "search-hide-matches-text": "Hide additional matches",
    "search-more-match-text": "more match in this document",
    "search-more-matches-text": "more matches in this document",
    "search-clear-button-title": "Clear",
    "search-text-placeholder": "",
    "search-detached-cancel-button-title": "Cancel",
    "search-submit-button-title": "Submit",
    "search-label": "Search"
  }
}</script>


</head>

<body class="nav-fixed fullcontent">

<div id="quarto-search-results"></div>
  <header id="quarto-header" class="headroom fixed-top">
    <nav class="navbar navbar-expand-lg " data-bs-theme="dark">
      <div class="navbar-container container-fluid">
      <div class="navbar-brand-container mx-auto">
    <a class="navbar-brand" href="./index.html">
    <span class="navbar-title">DS4i Writeup</span>
    </a>
  </div>
            <div id="quarto-search" class="" title="Search"></div>
          <button class="navbar-toggler" type="button" data-bs-toggle="collapse" data-bs-target="#navbarCollapse" aria-controls="navbarCollapse" role="menu" aria-expanded="false" aria-label="Toggle navigation" onclick="if (window.quartoToggleHeadroom) { window.quartoToggleHeadroom(); }">
  <span class="navbar-toggler-icon"></span>
</button>
          <div class="collapse navbar-collapse" id="navbarCollapse">
            <ul class="navbar-nav navbar-nav-scroll me-auto">
  <li class="nav-item">
    <a class="nav-link" href="./index.html"> 
<span class="menu-text">Home</span></a>
  </li>  
  <li class="nav-item">
    <a class="nav-link" href="./DS4i_writeup.html"> 
<span class="menu-text">Report</span></a>
  </li>  
  <li class="nav-item">
    <a class="nav-link active" href="./llm_use.html" aria-current="page"> 
<span class="menu-text">LLM</span></a>
  </li>  
  <li class="nav-item">
    <a class="nav-link" href="./plag_decl.html"> 
<span class="menu-text">Plagiarism Declaration</span></a>
  </li>  
  <li class="nav-item">
    <a class="nav-link" href="./mlp_model_report.html"> 
<span class="menu-text">Final Model</span></a>
  </li>  
</ul>
          </div> <!-- /navcollapse -->
            <div class="quarto-navbar-tools">
</div>
      </div> <!-- /container-fluid -->
    </nav>
</header>
<!-- content -->
<div id="quarto-content" class="quarto-container page-columns page-rows-contents page-layout-article page-navbar">
<!-- sidebar -->
<!-- margin-sidebar -->
    
<!-- main -->
<main class="content" id="quarto-document-content">

<header id="title-block-header" class="quarto-title-block default">
<div class="quarto-title">
<h1 class="title">LLM use</h1>
</div>



<div class="quarto-title-meta">

    
  
    
  </div>
  


</header>


<p>Coming into this project, our team had little to no domain knowledge on avalanches, Scottish weather, or forecasting. With a large project scope and only three weeks to complete it, we used LLMs (ChatGPT, Gemini, and Llama) as a sort of personal tutor to help us get up to speed quickly. What and how each of us used LLMs for depended largely on our specific roles, including:</p>
<ol type="1">
<li><p><strong>Domain understanding:</strong></p>
<p>Given our limited experience and knowledge on avalanches and forecasting, LLMs were used to quickly explain the basics of avalanche forecasting and highlight potential important variables, which were fact-checked against SAIS resources and when performing the literature review. Responses to prompts such as (<a href="https://chatgpt.com/share/68d51b49-d840-8002-ac38-577a47687625">https://chatgpt.com/share/68d51b49-d840-8002-ac38-577a47687625</a>):</p>
<div style="margin-left: 2em">
<ol type="a">
<li>
<em>What are some important things to know about Avalanche data for a data scientist predicting a neural network model to forecast avalanche severity categories? As a data scientist who does not have a background in weather forecasting</em>
</li>
<li>
<em>What would be the best structure for this? What are the key objectives we are looking to do according to the brief?</em>
</li>
<li>
<em>What variables are normally the most important in predicting avalanches?</em>
</li>
</ol>
</div>
<p>…gave us a good starting point and helped us understand the context quickly. Because ChatGPT highlighted aspects such as sparse data and class imbalances, these issues stood out more clearly when examining our own dataset. While generally informative, ChatGPT was not always correct or sometimes suggested overly complex approaches to some of our challenges. For example, it recommended handling data sparsity with imputation. We tried this, but after discussing with our lecturer, we realised simpler solutions were more appropriate for this assignment. Additionally, we found that performing a keyword search on Google Scholar and Scopus during our literature review process was far quicker and more reliable than asking ChatGPT for sources, as we were cautious due to previous experiences where ChatGPT produced inaccurate or fabricated references. This approach saved significant time by reducing the need for extensive fact-checking.</p></li>
<li><p><strong>Exploratory Data Analysis (EDA)</strong></p>
<p>ChatGPT was primarily used to assist with code generation of various plots and help identify gaps in interpretation of those plots. For plotting graphs, it was especially helpful with quickly generating “base” code and helping to brainstorm what type of plot would best show the relationships between certain predictors. Small tasks, such as formatting and colour palettes, were also delegated to LLMs to save time. During analysis, ChatGPT was used to validate that our initial interpretations were correct, as well as to identify other points we had missed out on (<a href="https://chatgpt.com/share/68d920ab-7f34-8012-8693-f1348cffb771">https://chatgpt.com/share/68d920ab-7f34-8012-8693-f1348cffb771</a>).</p></li>
<li><p><strong>Feature Engineering and Modelling</strong></p>
<p>LLMs were also used to support decisions on how best to handle temporal trends and how to control for this in the context of neural networks. For example, ChatGPT suggested creating new variables to represent the seasonal trends and using a rolling window for CNN and RNN (<a href="https://chatgpt.com/share/68d5946a-ef3c-8004-99a9-e2fb46c1d320">https://chatgpt.com/share/68d5946a-ef3c-8004-99a9-e2fb46c1d320</a>). After researching and finding that these approaches were valuable, we implemented this into our project.</p>
<p>Additionally, ChatGPT was used as a coding assistant in the feedforward neural network modelling process, to refine code, debug issues, and generate structured explanations of neural network hyperparameters and evaluation metrics (<a href="https://chatgpt.com/share/68d914d2-e42c-8001-b208-6946cf96a535">https://chatgpt.com/share/68d914d2-e42c-8001-b208-6946cf96a535</a>). By supplying details of the dataset, objectives, and error messages, the LLM provided possible fixed and restructuring suggestions, which were tested and refined in R Studio.</p></li>
</ol>
<p>Another useful application was that we asked ChatGPT to produce an interactive animation to demonstrate how convolutional neural networks work. It produced this animation in html, although it took several iterations for the LLM to produce an outcome we were satisfied with. For example, one iteration of the animation had incorrect calculations for the dot product. Despite numerous attempts, the model could not rectify this issue in the code, perhaps due to the complexity and number of tokens required to process. To overcome this, we prompted ChatGPT to simply produce an animation that merely inputs the numbers into the graphic, rather than calculating the dot product directly. Then, we went into the file ourselves and changed the values to the correct workings (<a href="https://chatgpt.com/share/68d59a8c-efa4-8004-a295-616e83f37afb">https://chatgpt.com/share/68d59a8c-efa4-8004-a295-616e83f37afb</a>; <a href="https://chatgpt.com/share/68d59ad3-d50c-8004-b862-18966277b186">https://chatgpt.com/share/68d59ad3-d50c-8004-b862-18966277b186</a>).</p>
<p>The LLM significantly accelerated the workflow by automating routine coding tasks and providing concise drafts for report sections. Their main strengths were efficiency, breadth of knowledge across R packages, and the ability to reformat and summarise results in scientific language. Its most valuable use was adding detailed comments in different code chunks. However, there were important limitations. Some code suggestions required correction due to inefficiencies or use of incompatible functions, sometimes even hallucinating packages or referencing outdated functions which is a result of its old training data. Additionally, outputs occasionally overstated the reliability of results.</p>
<ol start="4" type="1">
<li><p><strong>Formatting, GitHub, and Keras</strong></p>
<p>LLMs were also extremely useful for addressing practical coding and workflow challenges (<a href="https://chatgpt.com/share/68d79583-1a28-8003-b629-12ce4bafd86f">https://chatgpt.com/share/68d79583-1a28-8003-b629-12ce4bafd86f</a>). For figure and table referencing in <em>.qmd</em> files, ChatGPT performed exceptionally well, providing the correct syntax and even automatically including in-text references. This proactive guidance saved time and reduced uncertainty, as it anticipated the need to reference figures and tables without explicit prompts.</p></li>
</ol>
<p>For version control issues, ChatGPT effectively guided us through Git errors. By copying the terminal output into the chat, we received:</p>
<ul>
<li>Clear explanations of what was going on<br>
</li>
<li>Clear steps to follow to rectify the error<br>
</li>
<li>Steps on how to safely proceed with my initial task (pushing my content to our project repository)</li>
</ul>
<p>Without this assistance, or using alternative resources such as YouTube videos, resolving merge conflicts would likely have taken considerably longer through trial and error. With ChatGPT, we were able to resume analysis promptly, making workflow more efficient.</p>
<p>However, LLMs were less successful with system-specific tasks, such as resolving Keras installation errors. Two of our models relied on Keras, but some team members’ computers lacked the necessary packages to integrate Python and R. This became an issue for the writing team, who needed to report on the modelling results but could not access the model predictions. When asked to assist, ChatGPT repeatedly suggested running <code>library(keras)</code>, despite the error messages clearly stating that the module was missing. Attempts to follow installation instructions from this LLM were unsuccessful, including links provided for package installers that redirected to unrelated pages (<a href="https://chatgpt.com/share/68d796cf-43cc-8003-ba48-c98ff0b05b7d">https://chatgpt.com/share/68d796cf-43cc-8003-ba48-c98ff0b05b7d</a>; <a href="https://chatgpt.com/share/68d79670-e654-8003-91b9-f09fb9ae00be">https://chatgpt.com/share/68d79670-e654-8003-91b9-f09fb9ae00be</a>).</p>
<p>When it comes to Keras installation, ChatGPT seems to have a very specific way of going about this, and if that doesn’t work, it struggles to deviate and explore other solutions. In this case, it is worthwhile going to someone who has the technical expertise to fix the issue. They can identify issues on a computer that an LLM cannot infer from prompts or ask questions that uncover information that is completely overlooked on the LLM’s side.</p>
<ol start="5" type="1">
<li><p><strong>Report Editing</strong></p>
<p>Lastly, LLMs were very effective for streamlining our writing and reducing word count by suggesting more concise phrasing and flagging redundant words or sentences (<a href="https://chatgpt.com/c/68d6aa64-0ae0-8322-81b2-8ba74f1cb58b">https://chatgpt.com/c/68d6aa64-0ae0-8322-81b2-8ba74f1cb58b</a>). While ChatGPT’s summaries often helped, they sometimes altered the meaning of sentences. This meant the writing team’s judgement was still required to determine what worked and what did not.</p></li>
</ol>
<hr>
<p>Overall, the above points demonstrate the importance of matching task complexity to the LLM’s capabilities. LLMs are valuable tools for scaffolding and accelerating tasks, but must be paired with critical evaluation, testing, and domain knowledge. In this project, final outputs were ultimately determined by our understanding of modelling, statistical validation, and careful checking of the LLM’s contributions. For accelerated understanding of domain knowledge, EDA plots, temporal trend suggestions, modelling assistance, and formatting, LLMs were exceptional at providing further information much more quickly than if we were to search for this ourselves. However, using it for the CNN interactive animation or resolving Keras installation issues, we had to work around LLM limitations, either simplifying tasks, or consulting other resources.</p>
<section id="references" class="level2">
<h2 class="anchored" data-anchor-id="references">References</h2>
<ol type="1">
<li><p>OpenAI. (2025). ChatGPT (GPT-5). [Large language model].<br>
<a href="https://chatgpt.com/share/68d51b49-d840-8002-ac38-577a47687625" class="uri">https://chatgpt.com/share/68d51b49-d840-8002-ac38-577a47687625</a></p></li>
<li><p>OpenAI. (2025). ChatGPT (GPT-5). [Large language model].<br>
<a href="https://chatgpt.com/share/68d5946a-ef3c-8004-99a9-e2fb46c1d320" class="uri">https://chatgpt.com/share/68d5946a-ef3c-8004-99a9-e2fb46c1d320</a></p></li>
<li><p>OpenAI. (2025). ChatGPT (GPT-5). [Large language model].<br>
<a href="https://chatgpt.com/share/68d59a8c-efa4-8004-a295-616e83f37afb" class="uri">https://chatgpt.com/share/68d59a8c-efa4-8004-a295-616e83f37afb</a></p></li>
<li><p>OpenAI. (2025). ChatGPT (GPT-5). [Large language model].<br>
<a href="https://chatgpt.com/share/68d59ad3-d50c-8004-b862-18966277b186" class="uri">https://chatgpt.com/share/68d59ad3-d50c-8004-b862-18966277b186</a></p></li>
<li><p>OpenAI. (2025). ChatGPT (GPT-5). [Large language model].<br>
<a href="https://chatgpt.com/share/68d79583-1a28-8003-b629-12ce4bafd86f" class="uri">https://chatgpt.com/share/68d79583-1a28-8003-b629-12ce4bafd86f</a></p></li>
<li><p>OpenAI. (2025). ChatGPT (GPT-5). [Large language model].<br>
<a href="https://chatgpt.com/share/68d796cf-43cc-8003-ba48-c98ff0b05b7d" class="uri">https://chatgpt.com/share/68d796cf-43cc-8003-ba48-c98ff0b05b7d</a></p></li>
<li><p>OpenAI. (2025). ChatGPT (GPT-5). [Large language model].<br>
<a href="https://chatgpt.com/share/68d79670-e654-8003-91b9-f09fb9ae00be" class="uri">https://chatgpt.com/share/68d79670-e654-8003-91b9-f09fb9ae00be</a></p></li>
<li><p>OpenAI. (2025). ChatGPT (GPT-5). [Large language model].<br>
<a href="https://chatgpt.com/c/68d6aa64-0ae0-8322-81b2-8ba74f1cb58b" class="uri">https://chatgpt.com/c/68d6aa64-0ae0-8322-81b2-8ba74f1cb58b</a></p></li>
<li><p>OpenAI. (2025). ChatGPT (GPT-5). [Large language model].<br>
<a href="https://chatgpt.com/share/68d914d2-e42c-8001-b208-6946cf96a535" class="uri">https://chatgpt.com/share/68d914d2-e42c-8001-b208-6946cf96a535</a></p></li>
<li><p>OpenAI. (2025). ChatGPT (GPT-5). [Large language model].<br>
<a href="https://chatgpt.com/share/68d920ab-7f34-8012-8693-f1348cffb771" class="uri">https://chatgpt.com/share/68d920ab-7f34-8012-8693-f1348cffb771</a></p></li>
</ol>


</section>

</main> <!-- /main -->
<script id="quarto-html-after-body" type="application/javascript">
window.document.addEventListener("DOMContentLoaded", function (event) {
  const toggleBodyColorMode = (bsSheetEl) => {
    const mode = bsSheetEl.getAttribute("data-mode");
    const bodyEl = window.document.querySelector("body");
    if (mode === "dark") {
      bodyEl.classList.add("quarto-dark");
      bodyEl.classList.remove("quarto-light");
    } else {
      bodyEl.classList.add("quarto-light");
      bodyEl.classList.remove("quarto-dark");
    }
  }
  const toggleBodyColorPrimary = () => {
    const bsSheetEl = window.document.querySelector("link#quarto-bootstrap");
    if (bsSheetEl) {
      toggleBodyColorMode(bsSheetEl);
    }
  }
  toggleBodyColorPrimary();  
  const icon = "";
  const anchorJS = new window.AnchorJS();
  anchorJS.options = {
    placement: 'right',
    icon: icon
  };
  anchorJS.add('.anchored');
  const isCodeAnnotation = (el) => {
    for (const clz of el.classList) {
      if (clz.startsWith('code-annotation-')) {                     
        return true;
      }
    }
    return false;
  }
  const onCopySuccess = function(e) {
    // button target
    const button = e.trigger;
    // don't keep focus
    button.blur();
    // flash "checked"
    button.classList.add('code-copy-button-checked');
    var currentTitle = button.getAttribute("title");
    button.setAttribute("title", "Copied!");
    let tooltip;
    if (window.bootstrap) {
      button.setAttribute("data-bs-toggle", "tooltip");
      button.setAttribute("data-bs-placement", "left");
      button.setAttribute("data-bs-title", "Copied!");
      tooltip = new bootstrap.Tooltip(button, 
        { trigger: "manual", 
          customClass: "code-copy-button-tooltip",
          offset: [0, -8]});
      tooltip.show();    
    }
    setTimeout(function() {
      if (tooltip) {
        tooltip.hide();
        button.removeAttribute("data-bs-title");
        button.removeAttribute("data-bs-toggle");
        button.removeAttribute("data-bs-placement");
      }
      button.setAttribute("title", currentTitle);
      button.classList.remove('code-copy-button-checked');
    }, 1000);
    // clear code selection
    e.clearSelection();
  }
  const getTextToCopy = function(trigger) {
      const codeEl = trigger.previousElementSibling.cloneNode(true);
      for (const childEl of codeEl.children) {
        if (isCodeAnnotation(childEl)) {
          childEl.remove();
        }
      }
      return codeEl.innerText;
  }
  const clipboard = new window.ClipboardJS('.code-copy-button:not([data-in-quarto-modal])', {
    text: getTextToCopy
  });
  clipboard.on('success', onCopySuccess);
  if (window.document.getElementById('quarto-embedded-source-code-modal')) {
    const clipboardModal = new window.ClipboardJS('.code-copy-button[data-in-quarto-modal]', {
      text: getTextToCopy,
      container: window.document.getElementById('quarto-embedded-source-code-modal')
    });
    clipboardModal.on('success', onCopySuccess);
  }
    var localhostRegex = new RegExp(/^(?:http|https):\/\/localhost\:?[0-9]*\//);
    var mailtoRegex = new RegExp(/^mailto:/);
      var filterRegex = new RegExp('/' + window.location.host + '/');
    var isInternal = (href) => {
        return filterRegex.test(href) || localhostRegex.test(href) || mailtoRegex.test(href);
    }
    // Inspect non-navigation links and adorn them if external
 	var links = window.document.querySelectorAll('a[href]:not(.nav-link):not(.navbar-brand):not(.toc-action):not(.sidebar-link):not(.sidebar-item-toggle):not(.pagination-link):not(.no-external):not([aria-hidden]):not(.dropdown-item):not(.quarto-navigation-tool):not(.about-link)');
    for (var i=0; i<links.length; i++) {
      const link = links[i];
      if (!isInternal(link.href)) {
        // undo the damage that might have been done by quarto-nav.js in the case of
        // links that we want to consider external
        if (link.dataset.originalHref !== undefined) {
          link.href = link.dataset.originalHref;
        }
      }
    }
  function tippyHover(el, contentFn, onTriggerFn, onUntriggerFn) {
    const config = {
      allowHTML: true,
      maxWidth: 500,
      delay: 100,
      arrow: false,
      appendTo: function(el) {
          return el.parentElement;
      },
      interactive: true,
      interactiveBorder: 10,
      theme: 'quarto',
      placement: 'bottom-start',
    };
    if (contentFn) {
      config.content = contentFn;
    }
    if (onTriggerFn) {
      config.onTrigger = onTriggerFn;
    }
    if (onUntriggerFn) {
      config.onUntrigger = onUntriggerFn;
    }
    window.tippy(el, config); 
  }
  const noterefs = window.document.querySelectorAll('a[role="doc-noteref"]');
  for (var i=0; i<noterefs.length; i++) {
    const ref = noterefs[i];
    tippyHover(ref, function() {
      // use id or data attribute instead here
      let href = ref.getAttribute('data-footnote-href') || ref.getAttribute('href');
      try { href = new URL(href).hash; } catch {}
      const id = href.replace(/^#\/?/, "");
      const note = window.document.getElementById(id);
      if (note) {
        return note.innerHTML;
      } else {
        return "";
      }
    });
  }
  const xrefs = window.document.querySelectorAll('a.quarto-xref');
  const processXRef = (id, note) => {
    // Strip column container classes
    const stripColumnClz = (el) => {
      el.classList.remove("page-full", "page-columns");
      if (el.children) {
        for (const child of el.children) {
          stripColumnClz(child);
        }
      }
    }
    stripColumnClz(note)
    if (id === null || id.startsWith('sec-')) {
      // Special case sections, only their first couple elements
      const container = document.createElement("div");
      if (note.children && note.children.length > 2) {
        container.appendChild(note.children[0].cloneNode(true));
        for (let i = 1; i < note.children.length; i++) {
          const child = note.children[i];
          if (child.tagName === "P" && child.innerText === "") {
            continue;
          } else {
            container.appendChild(child.cloneNode(true));
            break;
          }
        }
        if (window.Quarto?.typesetMath) {
          window.Quarto.typesetMath(container);
        }
        return container.innerHTML
      } else {
        if (window.Quarto?.typesetMath) {
          window.Quarto.typesetMath(note);
        }
        return note.innerHTML;
      }
    } else {
      // Remove any anchor links if they are present
      const anchorLink = note.querySelector('a.anchorjs-link');
      if (anchorLink) {
        anchorLink.remove();
      }
      if (window.Quarto?.typesetMath) {
        window.Quarto.typesetMath(note);
      }
      if (note.classList.contains("callout")) {
        return note.outerHTML;
      } else {
        return note.innerHTML;
      }
    }
  }
  for (var i=0; i<xrefs.length; i++) {
    const xref = xrefs[i];
    tippyHover(xref, undefined, function(instance) {
      instance.disable();
      let url = xref.getAttribute('href');
      let hash = undefined; 
      if (url.startsWith('#')) {
        hash = url;
      } else {
        try { hash = new URL(url).hash; } catch {}
      }
      if (hash) {
        const id = hash.replace(/^#\/?/, "");
        const note = window.document.getElementById(id);
        if (note !== null) {
          try {
            const html = processXRef(id, note.cloneNode(true));
            instance.setContent(html);
          } finally {
            instance.enable();
            instance.show();
          }
        } else {
          // See if we can fetch this
          fetch(url.split('#')[0])
          .then(res => res.text())
          .then(html => {
            const parser = new DOMParser();
            const htmlDoc = parser.parseFromString(html, "text/html");
            const note = htmlDoc.getElementById(id);
            if (note !== null) {
              const html = processXRef(id, note);
              instance.setContent(html);
            } 
          }).finally(() => {
            instance.enable();
            instance.show();
          });
        }
      } else {
        // See if we can fetch a full url (with no hash to target)
        // This is a special case and we should probably do some content thinning / targeting
        fetch(url)
        .then(res => res.text())
        .then(html => {
          const parser = new DOMParser();
          const htmlDoc = parser.parseFromString(html, "text/html");
          const note = htmlDoc.querySelector('main.content');
          if (note !== null) {
            // This should only happen for chapter cross references
            // (since there is no id in the URL)
            // remove the first header
            if (note.children.length > 0 && note.children[0].tagName === "HEADER") {
              note.children[0].remove();
            }
            const html = processXRef(null, note);
            instance.setContent(html);
          } 
        }).finally(() => {
          instance.enable();
          instance.show();
        });
      }
    }, function(instance) {
    });
  }
      let selectedAnnoteEl;
      const selectorForAnnotation = ( cell, annotation) => {
        let cellAttr = 'data-code-cell="' + cell + '"';
        let lineAttr = 'data-code-annotation="' +  annotation + '"';
        const selector = 'span[' + cellAttr + '][' + lineAttr + ']';
        return selector;
      }
      const selectCodeLines = (annoteEl) => {
        const doc = window.document;
        const targetCell = annoteEl.getAttribute("data-target-cell");
        const targetAnnotation = annoteEl.getAttribute("data-target-annotation");
        const annoteSpan = window.document.querySelector(selectorForAnnotation(targetCell, targetAnnotation));
        const lines = annoteSpan.getAttribute("data-code-lines").split(",");
        const lineIds = lines.map((line) => {
          return targetCell + "-" + line;
        })
        let top = null;
        let height = null;
        let parent = null;
        if (lineIds.length > 0) {
            //compute the position of the single el (top and bottom and make a div)
            const el = window.document.getElementById(lineIds[0]);
            top = el.offsetTop;
            height = el.offsetHeight;
            parent = el.parentElement.parentElement;
          if (lineIds.length > 1) {
            const lastEl = window.document.getElementById(lineIds[lineIds.length - 1]);
            const bottom = lastEl.offsetTop + lastEl.offsetHeight;
            height = bottom - top;
          }
          if (top !== null && height !== null && parent !== null) {
            // cook up a div (if necessary) and position it 
            let div = window.document.getElementById("code-annotation-line-highlight");
            if (div === null) {
              div = window.document.createElement("div");
              div.setAttribute("id", "code-annotation-line-highlight");
              div.style.position = 'absolute';
              parent.appendChild(div);
            }
            div.style.top = top - 2 + "px";
            div.style.height = height + 4 + "px";
            div.style.left = 0;
            let gutterDiv = window.document.getElementById("code-annotation-line-highlight-gutter");
            if (gutterDiv === null) {
              gutterDiv = window.document.createElement("div");
              gutterDiv.setAttribute("id", "code-annotation-line-highlight-gutter");
              gutterDiv.style.position = 'absolute';
              const codeCell = window.document.getElementById(targetCell);
              const gutter = codeCell.querySelector('.code-annotation-gutter');
              gutter.appendChild(gutterDiv);
            }
            gutterDiv.style.top = top - 2 + "px";
            gutterDiv.style.height = height + 4 + "px";
          }
          selectedAnnoteEl = annoteEl;
        }
      };
      const unselectCodeLines = () => {
        const elementsIds = ["code-annotation-line-highlight", "code-annotation-line-highlight-gutter"];
        elementsIds.forEach((elId) => {
          const div = window.document.getElementById(elId);
          if (div) {
            div.remove();
          }
        });
        selectedAnnoteEl = undefined;
      };
        // Handle positioning of the toggle
    window.addEventListener(
      "resize",
      throttle(() => {
        elRect = undefined;
        if (selectedAnnoteEl) {
          selectCodeLines(selectedAnnoteEl);
        }
      }, 10)
    );
    function throttle(fn, ms) {
    let throttle = false;
    let timer;
      return (...args) => {
        if(!throttle) { // first call gets through
            fn.apply(this, args);
            throttle = true;
        } else { // all the others get throttled
            if(timer) clearTimeout(timer); // cancel #2
            timer = setTimeout(() => {
              fn.apply(this, args);
              timer = throttle = false;
            }, ms);
        }
      };
    }
      // Attach click handler to the DT
      const annoteDls = window.document.querySelectorAll('dt[data-target-cell]');
      for (const annoteDlNode of annoteDls) {
        annoteDlNode.addEventListener('click', (event) => {
          const clickedEl = event.target;
          if (clickedEl !== selectedAnnoteEl) {
            unselectCodeLines();
            const activeEl = window.document.querySelector('dt[data-target-cell].code-annotation-active');
            if (activeEl) {
              activeEl.classList.remove('code-annotation-active');
            }
            selectCodeLines(clickedEl);
            clickedEl.classList.add('code-annotation-active');
          } else {
            // Unselect the line
            unselectCodeLines();
            clickedEl.classList.remove('code-annotation-active');
          }
        });
      }
  const findCites = (el) => {
    const parentEl = el.parentElement;
    if (parentEl) {
      const cites = parentEl.dataset.cites;
      if (cites) {
        return {
          el,
          cites: cites.split(' ')
        };
      } else {
        return findCites(el.parentElement)
      }
    } else {
      return undefined;
    }
  };
  var bibliorefs = window.document.querySelectorAll('a[role="doc-biblioref"]');
  for (var i=0; i<bibliorefs.length; i++) {
    const ref = bibliorefs[i];
    const citeInfo = findCites(ref);
    if (citeInfo) {
      tippyHover(citeInfo.el, function() {
        var popup = window.document.createElement('div');
        citeInfo.cites.forEach(function(cite) {
          var citeDiv = window.document.createElement('div');
          citeDiv.classList.add('hanging-indent');
          citeDiv.classList.add('csl-entry');
          var biblioDiv = window.document.getElementById('ref-' + cite);
          if (biblioDiv) {
            citeDiv.innerHTML = biblioDiv.innerHTML;
          }
          popup.appendChild(citeDiv);
        });
        return popup.innerHTML;
      });
    }
  }
});
</script>
</div> <!-- /content -->




</body></html>